name: Set Jira Key to PR

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  set-jira-key:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Jira Key
        id: jira
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          JIRA_KEY=$(echo "$BRANCH_NAME" | grep -oE '^[A-Z]+-[0-9]+')
          echo "jira_key=$JIRA_KEY" >> $GITHUB_OUTPUT

      - name: Update PR title
        if: steps.jira.outputs.jira_key != ''
        uses: actions/github-script@v7
        with:
          script: |
            const jiraKey = '${{ steps.jira.outputs.jira_key }}';
            const pr = context.payload.pull_request;
            if (!pr.title.startsWith(`[${jiraKey}]`)) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                title: `[${jiraKey}] ${pr.title}`,
              });
            }
