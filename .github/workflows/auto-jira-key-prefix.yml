name: Auto Jira Key Prefix

on:
  pull_request:
    types: [opened, edited]

  push:
    branches:
      - '**'  # 모든 브랜치에서 커밋 감지

jobs:
  add-jira-key:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prefix multiple commits with Jira issue key
        if: github.event_name == 'push'
        run: |
          set -e
          # 브랜치 이름 추출
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          ISSUE_KEY=$(echo "$BRANCH_NAME" | grep -oE '[A-Z]+-[0-9]+')
          if [ -z "$ISSUE_KEY" ]; then
            echo "⚠️ Branch name does not contain Jira key. Skipping commit prefix."
            exit 0
          fi
      
          echo "✅ Jira key detected from branch: $ISSUE_KEY"
      
          # origin/main 기준으로 새 커밋 목록 가져오기
          COMMITS=$(git rev-list --reverse origin/main..HEAD)
      
          # 커밋별로 Jira 키 prefix 추가
          for HASH in $COMMITS; do
            # 커밋 메시지 가져오기
            MSG=$(git log -1 --pretty=%B "$HASH")
            
            # 이미 키가 있으면 건너뜀
            if [[ "$MSG" =~ \[$ISSUE_KEY\] ]]; then
              echo "⏭ Commit $HASH already has Jira key"
              continue
            fi
      
            # 메시지 수정
            git filter-branch -f --msg-filter "echo [$ISSUE_KEY] $MSG" "$HASH"^.."$HASH"
            echo "✅ Commit $HASH amended with [$ISSUE_KEY]"
          done
